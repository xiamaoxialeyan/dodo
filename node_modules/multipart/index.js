var formidable = require('formidable');

module.exports = function(opts) {
    opts || (opts = {});

    return function(req, res, next) {
        if (req.method !== 'POST' || !req.is('multipart/form-data') || Object.keys(req.body).length)
            return next();

        req.files = {};

        var form = new formidable.IncomingForm(opts);
        form.parse(req, function(err, fields, files) {
            if (err) {
                err.upload = true;
                next(err);
                return;
            }

            req.body = fields;
            req.files = files;
            next();
        });
    }
}